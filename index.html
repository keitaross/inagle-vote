<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¤ãƒŠã‚ºãƒã‚­ãƒ£ãƒ©äººæ°—æŠ•ç¥¨</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f2f6ff;
  margin: 0;
  padding: 16px;
}
h1 { text-align: center; margin-bottom: 6px; }
.note { text-align: center; font-size: 14px; color: #555; margin-bottom: 10px; }
#timer { text-align: center; font-weight: bold; margin-bottom: 16px; }

ul { list-style: none; padding: 0; max-width: 520px; margin: auto; }

.card {
  background: #fff;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 12px;
  box-shadow: 0 6px 14px rgba(0,0,0,.08);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.rank { font-size: 20px; font-weight: bold; margin-right: 6px; }
.gold { color: #f5b400; }
.silver { color: #999; }
.bronze { color: #c4703d; }

.name { font-weight: bold; font-size: 16px; }
.count {
  font-size: 13px;
  color: #fff;
  background: #4a6cff;
  padding: 4px 10px;
  border-radius: 999px;
  display: inline-block;
  margin-top: 4px;
}
.vote-btn {
  border: none;
  border-radius: 999px;
  padding: 10px 16px;
  font-size: 14px;
  font-weight: bold;
  background: linear-gradient(135deg,#ffcc00,#ff9900);
  cursor: pointer;
}
.vote-btn:disabled {
  background: #ccc;
  color: #666;
  cursor: not-allowed;
}
</style>
</head>

<body>

<h1>âš¡ ã‚¤ãƒŠã‚ºãƒã‚­ãƒ£ãƒ©äººæ°—æŠ•ç¥¨</h1>
<p class="note">â€»åŒ¿åãƒ»1æ—¥1ç¥¨</p>
<p id="timer"></p>

<ul id="list"></ul>

<script src="characters.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

<script>
/* ===============================
   Firebaseè¨­å®š
================================ */
firebase.initializeApp({
  apiKey: "AIzaSyD6f_e8MRzBTbuDM9Wx3V7-XygeVvryLd0",
  authDomain: "inazuma-vote-85c68.firebaseapp.com",
  projectId: "inazuma-vote-85c68",
});

const db = firebase.firestore();
const auth = firebase.auth();

/* ===============================
   ç®¡ç†è¨­å®š
================================ */
// â° æŠ•ç¥¨çµ‚äº†æ—¥æ™‚
const VOTE_END = new Date("2025-12-31T23:59:59+09:00").getTime();

// ğŸ”‘ ç®¡ç†è€…UIDï¼ˆå¿…è¦ãªã‚‰è¨­å®šï¼‰
const ADMIN_UID = ""; // â† ç®¡ç†è€…ã«ã—ãŸã„uidã‚’å…¥ã‚Œã‚‹

/* ===============================
   æŠ•ç¥¨çµ‚äº†ã‚¿ã‚¤ãƒãƒ¼
================================ */
let voteClosed = false;
const timerEl = document.getElementById("timer");

function updateTimer() {
  const diff = VOTE_END - Date.now();
  if (diff <= 0) {
    timerEl.textContent = "â›” æŠ•ç¥¨ã¯çµ‚äº†ã—ã¾ã—ãŸ";
    timerEl.style.color = "#c00";
    voteClosed = true;
    return;
  }
  const d = Math.floor(diff / 86400000);
  const h = Math.floor(diff / 3600000 % 24);
  const m = Math.floor(diff / 60000 % 60);
  timerEl.textContent = `â³ æŠ•ç¥¨çµ‚äº†ã¾ã§ï¼š${d}æ—¥ ${h}æ™‚é–“ ${m}åˆ†`;
}
updateTimer();
setInterval(updateTimer, 60000);

/* ===============================
   åŒ¿åãƒ­ã‚°ã‚¤ãƒ³
================================ */
auth.signInAnonymously();

/* ===============================
   ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æç”»
================================ */
const list = document.getElementById("list");
let cache = {};

characters.forEach(name => {
  db.collection("votes").doc(name).onSnapshot(doc => {
    cache[name] = doc.exists ? doc.data().count : 0;
    render();
  });
});

async function render() {
  list.innerHTML = "";

  const sorted = Object.entries(cache).sort((a,b)=>b[1]-a[1]);

  for (let i=0;i<sorted.length;i++) {
    const [name,count] = sorted[i];
    let rank = i+1, cls="";
    if(rank===1){rank="ğŸ¥‡";cls="gold"}
    if(rank===2){rank="ğŸ¥ˆ";cls="silver"}
    if(rank===3){rank="ğŸ¥‰";cls="bronze"}

    const li = document.createElement("li");
    li.className = "card";
    li.innerHTML = `
      <div>
        <span class="rank ${cls}">${rank}</span>
        <span class="name">${name}</span><br>
        <span class="count">${count} ç¥¨</span>
      </div>
      <button class="vote-btn">æŠ•ç¥¨</button>
    `;

    const btn = li.querySelector("button");
    btn.disabled = voteClosed;

    btn.onclick = async () => {
      if (voteClosed) return;

      const user = auth.currentUser;
      if (!user) return alert("ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã§ã™");

      const today = new Date().toISOString().slice(0,10);
      const userRef = db.collection("users").doc(user.uid);
      const snap = await userRef.get();

      if (snap.exists && snap.data().lastVote === today) {
        alert("æœ¬æ—¥ã¯ã™ã§ã«æŠ•ç¥¨ã—ã¦ã„ã¾ã™");
        return;
      }

      await db.collection("votes").doc(name).set({
        count: firebase.firestore.FieldValue.increment(1)
      }, { merge:true });

      await userRef.set({ lastVote: today });

      alert("æŠ•ç¥¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼");
    };

    list.appendChild(li);
  }
}
</script>

</body>
</html>
